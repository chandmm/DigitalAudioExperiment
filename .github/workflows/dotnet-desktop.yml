name: Build and Package
# Generated by ChatGPT
on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:

  build:

    runs-on: windows-2022  # Use Windows Server 2022 runner

    env:
      Solution_Name: DigitalAudioExperiment.sln
      Configuration: Release

    steps:
    - name: Checkout Source Code
      uses: actions/checkout@v4

    - name: Setup .NET SDK
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '8.0.x'  # Use .NET 8 SDK

    - name: Install Visual Studio Installer Projects Extension
      run: |
        # Download the extension VSIX file
        Invoke-WebRequest -Uri "https://marketplace.visualstudio.com/_apis/public/gallery/publishers/MicrosoftVisualStudio/vsextensions/Microsoft.VisualStudio2022InstallerProjects/2.0.226/vspackage" -OutFile "Microsoft.VisualStudio.InstallerProjects.vsix" -Headers @{ "Accept" = "application/octet-stream" }
        # Find the path to Visual Studio using vswhere
        $vsPath = &"C:\Program Files\Microsoft Visual Studio\Installer\vswhere.exe" -latest -property installationPath
        Write-Host "Visual Studio Path: $vsPath"
        # Install the extension
        Start-Process -FilePath "$vsPath\Common7\IDE\VSIXInstaller.exe" -ArgumentList '/quiet', '/admin', 'Microsoft.VisualStudio.InstallerProjects.vsix' -Wait

    - name: Build the .NET 8 Application
      run: dotnet build ${{ env.Solution_Name }} --configuration ${{ env.Configuration }}

    - name: Build the Installer Project
      run: |
        # Find the path to devenv.com
        $vsPath = &"C:\Program Files\Microsoft Visual Studio\Installer\vswhere.exe" -latest -property installationPath
        Write-Host "Visual Studio Path: $vsPath"
        &"$vsPath\Common7\IDE\devenv.com" ${{ env.Solution_Name }} /Build "${{ env.Configuration }}|Any CPU"

    - name: List Installer Output Directory
      run: |
        dir "DigitalAudioExperimentInstaller\bin\${{ env.Configuration }}"

    - name: Upload MSI Installer Artifact
      uses: actions/upload-artifact@v3
      with:
        name: MSI Installer
        path: 'DigitalAudioExperimentInstaller\bin\${{ env.Configuration }}\DigitalAudioExperimentInstaller.msi'
